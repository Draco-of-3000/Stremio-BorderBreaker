name: Windows Build

on:
  push:
    branches:
      - master
    tags:
      - "v*"
  pull_request:
    branches:
      - master
  workflow_dispatch:

env:
  QTDIR: C:\Qt\5.15.2\msvc2019_64
  Qt5_DIR: C:\Qt\5.15.2\msvc2019_64\lib\cmake\Qt5

jobs:
  build:
    runs-on: windows-latest
    outputs:
      package_version: ${{ steps.version.outputs.package_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Determine version
        id: version
        shell: pwsh
        run: |
          $match = Select-String -Path .\CMakeLists.txt -Pattern 'project\(stremio VERSION "([^"]+)"\)'
          if (-not $match) { throw "Unable to determine package version" }
          $version = $match.Matches[0].Groups[1].Value
          "PACKAGE_VERSION=$version" >> $env:GITHUB_ENV
          "package_version=$version" >> $env:GITHUB_OUTPUT

      - name: Upgrade pip and install aqt
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install aqtinstall

      - name: Install Qt 5.15.2
        shell: pwsh
        run: |
          $qtDir = "$env:QTDIR"
          $qmake = Join-Path $qtDir "bin\qmake.exe"
          if (-not (Test-Path $qmake)) {
            python -m aqt install-qt windows desktop 5.15.2 win64_msvc2019_64 -O C:\Qt --modules qtwebengine
          } else {
            Write-Host "Qt already installed at $qtDir"
          }

      - name: Install tools
        shell: pwsh
        run: |
          choco install -y 7zip nsis
          Copy-Item -Path "windows\NsProcess\Include\nsProcess.nsh" -Destination "C:\Program Files (x86)\NSIS\Include" -Force
          Copy-Item -Path "windows\NsProcess\Plugin\x86-ansi\nsProcess.dll" -Destination "C:\Program Files (x86)\NSIS\Plugins\x86-ansi" -Force
          Copy-Item -Path "windows\NsProcess\Plugin\x86-unicode\nsProcess.dll" -Destination "C:\Program Files (x86)\NSIS\Plugins\x86-unicode" -Force

      - name: Install OpenSSL
        shell: pwsh
        run: |
          $url = "https://slproweb.com/download/Win64OpenSSL-1_1_1w.exe"
          $installer = "$env:RUNNER_TEMP\Win64OpenSSL.exe"
          Invoke-WebRequest -Uri $url -OutFile $installer
          Start-Process $installer -ArgumentList '/silent','/verysilent','/sp-','/suppressmsgboxes','/dir=C:\OpenSSL-Win64' -Wait
          Remove-Item $installer
          "OPENSSL_BIN_PATH=C:\OpenSSL-Win64\bin" >> $env:GITHUB_ENV

      - uses: actions/setup-node@v4
        with:
          node-version: "14.15.0"

      - name: Expose node executable
        shell: pwsh
        run: |
          $node = (Get-Command node).Source
          "NODE_EXE=$node" >> $env:GITHUB_ENV

      - name: Download mpv runtime
      shell: pwsh
      run: |
          $mpvUrls = @(
            "https://downloads.sourceforge.net/project/mpv-player-windows/libmpv/mpv-dev-x86_64-v3-20251116-git-701201b.7z?viasf=1",
            "https://downloads.sourceforge.net/project/mpv-player-windows/libmpv/mpv-dev-x86_64-v3-20251026-git-aa2dad0.7z?viasf=1"
          )
          $downloaded = $false
          foreach ($url in $mpvUrls) {
            try {
              Write-Host "Downloading mpv from $url"
              if (Test-Path mpv-dev.7z) { Remove-Item mpv-dev.7z -Force }
              cmd /c "curl.exe -L --retry 5 --retry-delay 5 -o mpv-dev.7z `"$url`""
              if (Test-Path mpv-dev.7z) {
                $size = (Get-Item mpv-dev.7z).Length
                if ($size -gt 1000000) {
                  $downloaded = $true
                  break
                } else {
                  Write-Warning "Downloaded mpv archive from $url is too small ($size bytes), trying next mirror..."
                }
              }
            } catch {
              Write-Warning "Failed to download mpv from $url : $_"
            }
          }
          if (-not $downloaded) {
            throw "Unable to download mpv archive from any mirror."
          }
          $mpvExtract = Join-Path $env:GITHUB_WORKSPACE "mpv-download"
          if (Test-Path $mpvExtract) { Remove-Item $mpvExtract -Recurse -Force }
          New-Item -ItemType Directory -Path $mpvExtract | Out-Null
          & "C:\Program Files\7-Zip\7z.exe" x mpv-dev.7z "-o$mpvExtract" -aoa | Out-Null
          $dllPath = Get-ChildItem $mpvExtract -Recurse -Include "libmpv-2.dll","libmpv.dll" | Select-Object -First 1
          if (-not $dllPath) {
            Write-Host "Contents of mpv archive:"
            Get-ChildItem $mpvExtract -Recurse | Select-Object FullName
            throw "mpv archive did not extract libmpv DLL as expected"
          }
          "MPV_DLL_PATH=$($dllPath.FullName)" >> $env:GITHUB_ENV

      - name: Download FFmpeg shared build
      shell: pwsh
      run: |
          $ffmpegUrls = @(
            "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-full.7z",
            "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.7z"
          )
          $ffmpegDownloaded = $false
          foreach ($url in $ffmpegUrls) {
            try {
              Write-Host "Downloading ffmpeg from $url"
              if (Test-Path ffmpeg.7z) { Remove-Item ffmpeg.7z -Force }
              Invoke-WebRequest -Uri $url -OutFile ffmpeg.7z
              if (Test-Path ffmpeg.7z) {
                $ffmpegDownloaded = $true
                break
              }
            } catch {
              Write-Warning "Failed to download ffmpeg from $url : $_"
            }
          }
          if (-not $ffmpegDownloaded) { throw "Unable to download ffmpeg archive." }
          if (Test-Path .\ffmpeg) { Remove-Item .\ffmpeg -Recurse -Force }
          & "C:\Program Files\7-Zip\7z.exe" x ffmpeg.7z -offmpeg -aoa | Out-Null
          $ffmpegRoot = Get-ChildItem .\ffmpeg -Directory | Where-Object { $_.Name -like "ffmpeg-*" } | Select-Object -First 1
          if (-not $ffmpegRoot) { throw "ffmpeg archive did not extract as expected" }
          "FFMPEG_BIN_PATH=$($ffmpegRoot.FullName)\bin" >> $env:GITHUB_ENV

      - name: Configure and build
      shell: pwsh
      run: |
          $vsPath = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.Component.MSBuild -property installationPath
          if (-not $vsPath) { throw "Visual Studio installation not found" }
          $vcvars = Join-Path $vsPath "VC\Auxiliary\Build\vcvars64.bat"
          $cmd = "call `"$vcvars`" && cmake -B build -G `"NMake Makefiles`" -DCMAKE_BUILD_TYPE=Release . && cmake --build build"
          cmd.exe /c $cmd

      - name: Package Windows artifacts
      shell: pwsh
      run: |
          $ErrorActionPreference = "Stop"
          $dist = Join-Path $PWD "dist-win"
          if (Test-Path $dist) { Remove-Item $dist -Recurse -Force }
          New-Item $dist -ItemType Directory | Out-Null

          Copy-Item build\*.exe $dist
          Copy-Item build\*.dll $dist
          Copy-Item windows\*.dll $dist -Force
          Copy-Item windows\*.exe $dist -Force
          Copy-Item windows\DS\* $dist -Force
          Copy-Item "$env:OPENSSL_BIN_PATH\*.dll" $dist -Force

          & windows\generate_stremio-runtime.cmd $dist

          $serverUrl = Get-Content .\server-url.txt -Raw
          $serverDest = Join-Path $dist "server.js"
          Write-Host "Downloading server.js from $serverUrl"
          curl.exe -L --retry 5 --retry-delay 5 -o "$serverDest" "$serverUrl"
          if (-not (Test-Path $serverDest) -or (Get-Item $serverDest).Length -lt 1024) {
            throw "server.js download failed or file is too small."
          }

          Copy-Item "$env:FFMPEG_BIN_PATH\ffmpeg.exe" $dist -Force
          Copy-Item "$env:FFMPEG_BIN_PATH\ffprobe.exe" $dist -Force
          Get-ChildItem "$env:FFMPEG_BIN_PATH\*.dll" | Copy-Item -Destination $dist -Force

          Copy-Item "$env:MPV_DLL_PATH" (Join-Path $dist "mpv-1.dll") -Force

          $windeploy = Join-Path $env:QTDIR 'bin\windeployqt.exe'
          & $windeploy --release --no-compiler-runtime --angle --qmldir=. (Join-Path $dist "stremio.exe")
          Set-Content -Path (Join-Path $dist "qt.conf") -Value "[Qt]`nangle=true`n" -Encoding ASCII

          $nsis = "${env:ProgramFiles(x86)}\NSIS\makensis.exe"
          & $nsis windows\installer\windows-installer.nsi

          Compress-Archive -Path "$dist\*" -DestinationPath "Stremio $env:PACKAGE_VERSION.zip" -Force

      - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
          name: stremio-windows
          path: |
            Stremio ${{ env.PACKAGE_VERSION }}.zip
            Stremio ${{ env.PACKAGE_VERSION }}.exe

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: stremio-windows
          path: artifacts

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v1
      with:
          tag_name: ${{ github.ref_name }}
          name: Stremio ${{ needs.build.outputs.package_version }}
          files: |
            artifacts/*.zip
            artifacts/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

