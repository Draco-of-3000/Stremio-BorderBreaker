name: Windows Build

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '14.15.0'
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '5.15.2'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64'
        modules: 'qtwebengine'
        cache: true
    
    - name: Install OpenSSL
      run: choco install openssl -y
      
    - name: Verify and export OpenSSL paths
      shell: pwsh
      run: |
        Write-Host "Looking for OpenSSL under common Program Files locations..."
        $candidates = @("C:\Program Files\OpenSSL-Win64","C:\Program Files (x86)\OpenSSL-Win64","C:\OpenSSL-Win64","C:\Program Files\OpenSSL","C:\OpenSSL")
        $found = $null
        foreach ($p in $candidates) {
          if (Test-Path $p) { $found = $p; break }
        }
        if (-not $found) {
          $found = Get-ChildItem "C:\Program Files" -Directory -ErrorAction SilentlyContinue | Where-Object { $_.Name -match 'OpenSSL' } | Select-Object -First 1 | ForEach-Object { $_.FullName }
        }
        if (-not $found) {
          Write-Error "OpenSSL installation not found. Inspect the runner or the choco install output."
          exit 1
        }
        Write-Host "OpenSSL found at: $found"
        echo "OPENSSL_ROOT_DIR=$found" >> $env:GITHUB_ENV
        echo "OPENSSL_INCLUDE_DIR=$found\include" >> $env:GITHUB_ENV
        echo "OPENSSL_LIB_DIR=$found\lib" >> $env:GITHUB_ENV
    
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
    
    - name: Download dependencies
      shell: pwsh
      run: |
        # Download server.js
        $serverUrl = Get-Content -Path ./server-url.txt
        Invoke-WebRequest -Uri $serverUrl -OutFile ./server.js
        
        # Download rcedit (needed for stremio-runtime generation)
        Invoke-WebRequest -Uri "https://github.com/electron/rcedit/releases/download/v1.1.1/rcedit-x86.exe" -OutFile ./rcedit-x86.exe
    
    - name: Build with CMake
      shell: pwsh
      run: |
        mkdir build
        cd build
        cmake -G "NMake Makefiles" -DCMAKE_BUILD_TYPE=Release -DOPENSSL_ROOT_DIR="$env:OPENSSL_ROOT_DIR" -DOPENSSL_INCLUDE_DIR="$env:OPENSSL_INCLUDE_DIR" -DOPENSSL_LIB_DIR="$env:OPENSSL_LIB_DIR" ..
        cmake --build .
    
    - name: Prepare dist-win directory
      shell: pwsh
      run: |
        # Create dist-win directory
        New-Item -ItemType Directory -Force -Path dist-win
        
        # Copy OpenSSL DLLs
        Copy-Item "$env:OPENSSL_ROOT_DIR\bin\*.dll" dist-win\ -ErrorAction SilentlyContinue
        
        # Copy FFmpeg and FFprobe executables
        Copy-Item windows\ffmpeg.exe dist-win\
        Copy-Item windows\ffprobe.exe dist-win\
        
        # Copy MPV and FFmpeg DLLs
        Copy-Item windows\*.dll dist-win\
        
        # Copy DS (Desktop Search) files
        Copy-Item windows\DS\DS.exe dist-win\
        Copy-Item windows\DS\Microsoft.Search.Interop.dll dist-win\
        
        # Copy VCRedist DLLs
        $vcredistPath = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Redist\MSVC"
        $vcredistVersion = Get-ChildItem $vcredistPath | Sort-Object Name -Descending | Select-Object -First 1
        $vcredistDlls = "$vcredistPath\$($vcredistVersion.Name)\x64\Microsoft.VC143.CRT"
        Copy-Item "$vcredistDlls\msvcp140.dll" dist-win\ -ErrorAction SilentlyContinue
        Copy-Item "$vcredistDlls\msvcp140_1.dll" dist-win\ -ErrorAction SilentlyContinue
        Copy-Item "$vcredistDlls\vccorlib140.dll" dist-win\ -ErrorAction SilentlyContinue
        Copy-Item "$vcredistDlls\vcruntime140.dll" dist-win\ -ErrorAction SilentlyContinue
        
        # Copy built Qt shell files
        Copy-Item build\*.dll dist-win\ -ErrorAction SilentlyContinue
        Copy-Item build\stremio.exe dist-win\
        
        # Copy server.js
        Copy-Item server.js dist-win\
    
    - name: Generate stremio-runtime.exe
      shell: cmd
      run: |
        REM Set Node.js path for the script
        set "NODE_PATH=C:\Program Files\nodejs\node.exe"
        
        REM Create a temporary batch file that sets the correct Node path
        echo @echo off > temp_generate.cmd
        echo set "node=C:\Program Files\nodejs\node.exe" >> temp_generate.cmd
        echo set "rt_path=%%~dpf1" >> temp_generate.cmd
        echo set rt_exe="%%rt_path%%\stremio-runtime.exe" >> temp_generate.cmd
        echo pushd %%~dp0 >> temp_generate.cmd
        echo set rcedit="%%cd%%\..\rcedit-x86.exe" >> temp_generate.cmd
        echo pushd ..\images >> temp_generate.cmd
        echo set rt_icon="%%cd%%\stremio_gray.ico" >> temp_generate.cmd
        echo popd >> temp_generate.cmd
        echo popd >> temp_generate.cmd
        echo if not exist %%rcedit%% goto :norcedit >> temp_generate.cmd
        echo if not exist %%node%% goto :nonode >> temp_generate.cmd
        echo if not exist %%rt_icon%% goto :noico >> temp_generate.cmd
        echo if not exist "%%rt_path%%\" goto :nodir >> temp_generate.cmd
        echo copy %%node%% "%%rt_exe%%" >> temp_generate.cmd
        echo %%rcedit%% %%rt_exe%% --set-icon %%rt_icon%% --set-version-string "ProductName" "StremioRuntime" --set-version-string "FileDescription" "Stremio Server JavaScript Runtime" --set-version-string "OriginalFilename" "stremio-runtime.exe" --set-version-string "InternalName" "stremio-runtime" >> temp_generate.cmd
        echo exit /b %%errorlevel%% >> temp_generate.cmd
        echo :norcedit >> temp_generate.cmd
        echo echo rcedit-x86.exe not found at %%rcedit%% >> temp_generate.cmd
        echo exit /b 1 >> temp_generate.cmd
        echo :nonode >> temp_generate.cmd
        echo echo Node.exe not found at %%node%% >> temp_generate.cmd
        echo exit /b 2 >> temp_generate.cmd
        echo :noico >> temp_generate.cmd
        echo echo Icon file not found at %%rt_icon%% >> temp_generate.cmd
        echo exit /b 3 >> temp_generate.cmd
        echo :nodir >> temp_generate.cmd
        echo echo Destination directory does not exists at %%rt_path%% >> temp_generate.cmd
        echo exit /b 4 >> temp_generate.cmd
        
        REM Run the script
        cd windows
        call ..\temp_generate.cmd ..\dist-win
    
    - name: Deploy Qt dependencies
      shell: pwsh
      run: |
        windeployqt --release --no-compiler-runtime --qmldir=. ./dist-win/stremio.exe
    
    - name: Install NSIS
      run: choco install nsis -y
    
    - name: Build installer
      shell: pwsh
      run: |
        # Set version for installer
        $env:package_version = "4.4.169-borderbreaker"
        
        # Build NSIS installer
        & "C:\Program Files (x86)\NSIS\makensis.exe" /V2 ./windows/installer/windows-installer.nsi
        
        # Create ZIP archive as well
        Compress-Archive -Path .\dist-win\* -DestinationPath "Stremio-BorderBreaker-$env:package_version.zip"
    
    - name: Upload installer
      uses: actions/upload-artifact@v4
      with:
        name: Stremio-BorderBreaker-Installer
        path: "*.exe"
        retention-days: 30
    
    - name: Upload ZIP
      uses: actions/upload-artifact@v4
      with:
        name: Stremio-BorderBreaker-Portable
        path: "*.zip"
        retention-days: 30


