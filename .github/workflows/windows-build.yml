name: Windows Build

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '14.15.0'
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '5.15.2'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64'
        modules: 'qtwebengine'
        cache: true
    
    - name: Install OpenSSL
      run: choco install openssl -y
      
    - name: Verify and export OpenSSL paths
      shell: pwsh
      run: |
        Write-Host "Looking for OpenSSL under common Program Files locations..."
        $candidates = @("C:\Program Files\OpenSSL-Win64","C:\Program Files (x86)\OpenSSL-Win64","C:\OpenSSL-Win64","C:\Program Files\OpenSSL","C:\OpenSSL")
        $found = $null
        foreach ($p in $candidates) {
          if (Test-Path $p) { $found = $p; break }
        }
        if (-not $found) {
          $found = Get-ChildItem "C:\Program Files" -Directory -ErrorAction SilentlyContinue | Where-Object { $_.Name -match 'OpenSSL' } | Select-Object -First 1 | ForEach-Object { $_.FullName }
        }
        if (-not $found) {
          Write-Error "OpenSSL installation not found. Inspect the runner or the choco install output."
          exit 1
        }
        Write-Host "OpenSSL found at: $found"
        echo "OPENSSL_ROOT_DIR=$found" >> $env:GITHUB_ENV
        echo "OPENSSL_INCLUDE_DIR=$found\include" >> $env:GITHUB_ENV
        echo "OPENSSL_LIB_DIR=$found\lib" >> $env:GITHUB_ENV
    
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
    
    - name: Download dependencies
      shell: pwsh
      run: |
        # Download server.js
        $serverUrl = Get-Content -Path ./server-url.txt
        Invoke-WebRequest -Uri $serverUrl -OutFile ./server.js
        
        # Download rcedit (needed for stremio-runtime generation)
        Invoke-WebRequest -Uri "https://github.com/electron/rcedit/releases/download/v1.1.1/rcedit-x86.exe" -OutFile ./rcedit-x86.exe
    
    - name: Build with CMake
      shell: pwsh
      run: |
        mkdir build
        cd build
        cmake -G "NMake Makefiles" -DCMAKE_BUILD_TYPE=Release -DOPENSSL_ROOT_DIR="$env:OPENSSL_ROOT_DIR" -DOPENSSL_INCLUDE_DIR="$env:OPENSSL_INCLUDE_DIR" -DOPENSSL_LIB_DIR="$env:OPENSSL_LIB_DIR" ..
        cmake --build .
    
    - name: Prepare dist-win directory
      shell: pwsh
      run: |
        # Create dist-win directory
        New-Item -ItemType Directory -Force -Path dist-win
        
        # Copy OpenSSL DLLs
        Copy-Item "$env:OPENSSL_ROOT_DIR\bin\*.dll" dist-win\ -ErrorAction SilentlyContinue
        
        # Copy FFmpeg and FFprobe executables
        Copy-Item windows\ffmpeg.exe dist-win\
        Copy-Item windows\ffprobe.exe dist-win\
        
        # Copy MPV and FFmpeg DLLs
        Copy-Item windows\*.dll dist-win\
        
        # Copy DS (Desktop Search) files
        Copy-Item windows\DS\DS.exe dist-win\
        Copy-Item windows\DS\Microsoft.Search.Interop.dll dist-win\
        
        # Copy VCRedist DLLs
        $vcredistPath = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Redist\MSVC"
        $vcredistVersion = Get-ChildItem $vcredistPath | Sort-Object Name -Descending | Select-Object -First 1
        $vcredistDlls = "$vcredistPath\$($vcredistVersion.Name)\x64\Microsoft.VC143.CRT"
        Copy-Item "$vcredistDlls\msvcp140.dll" dist-win\ -ErrorAction SilentlyContinue
        Copy-Item "$vcredistDlls\msvcp140_1.dll" dist-win\ -ErrorAction SilentlyContinue
        Copy-Item "$vcredistDlls\vccorlib140.dll" dist-win\ -ErrorAction SilentlyContinue
        Copy-Item "$vcredistDlls\vcruntime140.dll" dist-win\ -ErrorAction SilentlyContinue
        
        # Copy built Qt shell files
        Copy-Item build\*.dll dist-win\ -ErrorAction SilentlyContinue
        Copy-Item build\stremio.exe dist-win\
        
        # Copy server.js
        Copy-Item server.js dist-win\
    
    - name: Generate stremio-runtime.exe
      shell: cmd
      run: |
        REM Get absolute paths
        set "WORKSPACE=%CD%"
        set "NODE_EXE=C:\Program Files\nodejs\node.exe"
        set "RCEDIT_EXE=%WORKSPACE%\rcedit-x86.exe"
        set "ICON_FILE=%WORKSPACE%\images\stremio_gray.ico"
        set "DIST_DIR=%WORKSPACE%\dist-win"
        
        REM Check if files exist
        if not exist "%NODE_EXE%" (
          echo Node.exe not found at %NODE_EXE%
          exit /b 1
        )
        if not exist "%RCEDIT_EXE%" (
          echo rcedit-x86.exe not found at %RCEDIT_EXE%
          exit /b 1
        )
        if not exist "%ICON_FILE%" (
          echo Icon file not found at %ICON_FILE%
          exit /b 1
        )
        
        REM Copy node.exe to stremio-runtime.exe
        copy "%NODE_EXE%" "%DIST_DIR%\stremio-runtime.exe"
        
        REM Patch the exe with rcedit
        "%RCEDIT_EXE%" "%DIST_DIR%\stremio-runtime.exe" --set-icon "%ICON_FILE%" --set-version-string "ProductName" "StremioRuntime" --set-version-string "FileDescription" "Stremio Server JavaScript Runtime" --set-version-string "OriginalFilename" "stremio-runtime.exe" --set-version-string "InternalName" "stremio-runtime"
    
    - name: Deploy Qt dependencies
      shell: pwsh
      run: |
        windeployqt --release --no-compiler-runtime --qmldir=. ./dist-win/stremio.exe
    
    - name: Install NSIS
      run: choco install nsis -y
      
    - name: Install NSIS Plugins
      shell: pwsh
      run: |
        $nsisPath = "${env:ProgramFiles(x86)}\NSIS"
        Copy-Item "windows/NsProcess/Include/nsProcess.nsh" "$nsisPath\Include\"
        Copy-Item "windows/NsProcess/Plugin/x86-unicode/nsProcess.dll" "$nsisPath\Plugins\x86-unicode\"
    
    - name: Build installer
      shell: pwsh
      run: |
        # Set version for installer (must be X.X.X format for NSIS)
        $env:package_version = "4.4.169"
        
        # Debug: Check if signing is disabled
        Get-Content ./windows/installer/windows-installer.nsi | Select-String "uninstfinalize"
        
        # Build NSIS installer
        & "C:\Program Files (x86)\NSIS\makensis.exe" /V2 ./windows/installer/windows-installer.nsi
        
        # Rename installer to include BorderBreaker
        Move-Item "Stremio $env:package_version.exe" "Stremio-BorderBreaker-$env:package_version.exe"
        
        # Create ZIP archive as well
        Compress-Archive -Path .\dist-win\* -DestinationPath "Stremio-BorderBreaker-$env:package_version.zip"
    
    - name: Upload installer
      uses: actions/upload-artifact@v4
      with:
        name: Stremio-BorderBreaker-Installer
        path: "*.exe"
        retention-days: 30
    
    - name: Upload ZIP
      uses: actions/upload-artifact@v4
      with:
        name: Stremio-BorderBreaker-Portable
        path: "*.zip"
        retention-days: 30
